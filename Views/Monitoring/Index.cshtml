@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Monitoring";
}

<div class="mb-4 text-sm px-4 sm:px-0">
    <a href="#" class="text-teal-500 font-semibold hover:text-teal-600 transition-colors">Pinpad List</a> /
    <span class="text-gray-500">Inquiry</span>
</div>

<!-- Filter Form -->
<div class="bg-white p-6 rounded-lg shadow mb-6">


    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- Left Column -->
        <div class="space-y-6">
            <!-- Regional -->
            <div>
                <label class="block text-gray-700 text-sm font-medium mb-2">Regional:</label>
                <select id="regionalSelect"
                    class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all">
                    <option>Loading...</option>
                </select>
            </div>

            <!-- Cabang Induk -->
            <div>
                <label class="block text-gray-700 text-sm font-medium mb-2">Cabang Induk:</label>
                <select id="cabangIndukSelect"
                    class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all">
                    <option value="">--Select Cabang Induk--</option>
                </select>
            </div>

            <!-- Outlet -->
            <div>
                <label class="block text-gray-700 text-sm font-medium mb-2">Outlet:</label>
                <select id="outletSelect"
                    class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all">
                    <option value="">--Select Outlet--</option>
                </select>
            </div>
        </div>

        <!-- Right Column -->
        <div class="space-y-6">
            <!-- Serial Number -->
            <div>
                <label class="block text-gray-700 text-sm font-medium mb-2">Serial Number:</label>
                <input type="text" placeholder="Please enter your Serial Number"
                    class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all">
            </div>

            <!-- Username -->
            <div>
                <label class="block text-gray-700 text-sm font-medium mb-2">Username:</label>
                <input type="text" placeholder="Please enter your Username"
                    class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all">
            </div>

            <!-- Status -->
            <div>
                <label class="block text-gray-700 text-sm font-medium mb-2">Status:</label>
                <select
                    class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all">
                    <option>--Select Status Pinpad--</option>
                    <option>Ready To Use</option>
                    <option>Not Ready To Use</option>
                    <option>Maintenance</option>
                    <option>In Use</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Search Button - Right Aligned -->
    <div class="mt-8 flex justify-end">
        <button
            class="bg-teal-500 hover:bg-teal-600 text-white px-8 py-3 rounded-lg font-medium transition-colors shadow-md hover:shadow-lg">
            <i class="fa fa-search mr-2"></i>Search
        </button>
    </div>
</div>

<!-- Table Container -->
<div class="bg-white shadow rounded-lg border border-gray-200 overflow-hidden">


    <!-- Custom Search and Length Menu -->
    <div class="px-4 sm:px-6 py-6 border-b border-gray-200">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <!-- Search Box -->
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-700">Search:</label>
                <input type="text" id="searchInput" placeholder="Search in all columns..."
                    class="border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent min-w-[250px]">
            </div>
        </div>
    </div>

    <!-- Table Responsive Wrapper -->
    <div class="overflow-x-auto">
        <table id="pinpadListTable" class="min-w-[1200px] w-full text-left border-collapse">
            <thead>
                <tr class="bg-gray-100 text-gray-700 text-sm">
                    <th class="px-4 py-3 font-semibold cursor-pointer hover:bg-gray-200 transition-colors whitespace-nowrap"
                        data-sortable="true">
                        <div class="flex items-center justify-between">
                            <span>Regional</span>
                            <div class="sort-indicator">
                                <i class="fa fa-sort text-gray-400"></i>
                                <i class="fa fa-sort-up text-blue-500 hidden"></i>
                                <i class="fa fa-sort-down text-blue-500 hidden"></i>
                            </div>
                        </div>
                    </th>
                    <th class="px-4 py-3 font-semibold cursor-pointer hover:bg-gray-200 transition-colors whitespace-nowrap"
                        data-sortable="true">
                        <div class="flex items-center justify-between">
                            <span>Cabang Induk</span>
                            <div class="sort-indicator">
                                <i class="fa fa-sort text-gray-400"></i>
                                <i class="fa fa-sort-up text-blue-500 hidden"></i>
                                <i class="fa fa-sort-down text-blue-500 hidden"></i>
                            </div>
                        </div>
                    </th>
                    <th class="px-4 py-3 font-semibold cursor-pointer hover:bg-gray-200 transition-colors whitespace-nowrap"
                        data-sortable="true">
                        <div class="flex items-center justify-between">
                            <span>Kode Outlet</span>
                            <div class="sort-indicator">
                                <i class="fa fa-sort text-gray-400"></i>
                                <i class="fa fa-sort-up text-blue-500 hidden"></i>
                                <i class="fa fa-sort-down text-blue-500 hidden"></i>
                            </div>
                        </div>
                    </th>
                    <th class="px-4 py-3 font-semibold cursor-pointer hover:bg-gray-200 transition-colors whitespace-nowrap"
                        data-sortable="true">
                        <div class="flex items-center justify-between">
                            <span>Location</span>
                            <div class="sort-indicator">
                                <i class="fa fa-sort text-gray-400"></i>
                                <i class="fa fa-sort-up text-blue-500 hidden"></i>
                                <i class="fa fa-sort-down text-blue-500 hidden"></i>
                            </div>
                        </div>
                    </th>
                    <th class="px-4 py-3 font-semibold cursor-pointer hover:bg-gray-200 transition-colors whitespace-nowrap"
                        data-sortable="true">
                        <div class="flex items-center justify-between">
                            <span>Register</span>
                            <div class="sort-indicator">
                                <i class="fa fa-sort text-gray-400"></i>
                                <i class="fa fa-sort-up text-blue-500 hidden"></i>
                                <i class="fa fa-sort-down text-blue-500 hidden"></i>
                            </div>
                        </div>
                    </th>
                    <th class="px-4 py-3 font-semibold cursor-pointer hover:bg-gray-200 transition-colors whitespace-nowrap"
                        data-sortable="true">
                        <div class="flex items-center justify-between">
                            <span>Update Date</span>
                            <div class="sort-indicator">
                                <i class="fa fa-sort text-gray-400"></i>
                                <i class="fa fa-sort-up text-blue-500 hidden"></i>
                                <i class="fa fa-sort-down text-blue-500 hidden"></i>
                            </div>
                        </div>
                    </th>
                    <th class="px-4 py-3 font-semibold cursor-pointer hover:bg-gray-200 transition-colors whitespace-nowrap"
                        data-sortable="true">
                        <div class="flex items-center justify-between">
                            <span>Serial Number</span>
                            <div class="sort-indicator">
                                <i class="fa fa-sort text-gray-400"></i>
                                <i class="fa fa-sort-up text-blue-500 hidden"></i>
                                <i class="fa fa-sort-down text-blue-500 hidden"></i>
                            </div>
                        </div>
                    </th>
                    <th class="px-4 py-3 font-semibold cursor-pointer hover:bg-gray-200 transition-colors whitespace-nowrap"
                        data-sortable="true">
                        <div class="flex items-center justify-between">
                            <span>TID</span>
                            <div class="sort-indicator">
                                <i class="fa fa-sort text-gray-400"></i>
                                <i class="fa fa-sort-up text-blue-500 hidden"></i>
                                <i class="fa fa-sort-down text-blue-500 hidden"></i>
                            </div>
                        </div>
                    </th>
                    <th class="px-4 py-3 font-semibold cursor-pointer hover:bg-gray-200 transition-colors whitespace-nowrap"
                        data-sortable="true">
                        <div class="flex items-center justify-between">
                            <span>Status Pinpad</span>
                            <div class="sort-indicator">
                                <i class="fa fa-sort text-gray-400"></i>
                                <i class="fa fa-sort-up text-blue-500 hidden"></i>
                                <i class="fa fa-sort-down text-blue-500 hidden"></i>
                            </div>
                        </div>
                    </th>
                    <th class="px-4 py-3 font-semibold cursor-pointer hover:bg-gray-200 transition-colors whitespace-nowrap"
                        data-sortable="true">
                        <div class="flex items-center justify-between">
                            <span>Create By</span>
                            <div class="sort-indicator">
                                <i class="fa fa-sort text-gray-400"></i>
                                <i class="fa fa-sort-up text-blue-500 hidden"></i>
                                <i class="fa fa-sort-down text-blue-500 hidden"></i>
                            </div>
                        </div>
                    </th>
                    <th class="px-4 py-3 font-semibold cursor-pointer hover:bg-gray-200 transition-colors whitespace-nowrap"
                        data-sortable="true">
                        <div class="flex items-center justify-between">
                            <span>IP Low</span>
                            <div class="sort-indicator">
                                <i class="fa fa-sort text-gray-400"></i>
                                <i class="fa fa-sort-up text-blue-500 hidden"></i>
                                <i class="fa fa-sort-down text-blue-500 hidden"></i>
                            </div>
                        </div>
                    </th>
                    <th class="px-4 py-3 font-semibold cursor-pointer hover:bg-gray-200 transition-colors whitespace-nowrap"
                        data-sortable="true">
                        <div class="flex items-center justify-between">
                            <span>IP High</span>
                            <div class="sort-indicator">
                                <i class="fa fa-sort text-gray-400"></i>
                                <i class="fa fa-sort-up text-blue-500 hidden"></i>
                                <i class="fa fa-sort-down text-blue-500 hidden"></i>
                            </div>
                        </div>
                    </th>
                    <th class="px-4 py-3 font-semibold cursor-pointer hover:bg-gray-200 transition-colors whitespace-nowrap"
                        data-sortable="true">
                        <div class="flex items-center justify-between">
                            <span>Last Activity</span>
                            <div class="sort-indicator">
                                <i class="fa fa-sort text-gray-400"></i>
                                <i class="fa fa-sort-up text-blue-500 hidden"></i>
                                <i class="fa fa-sort-down text-blue-500 hidden"></i>
                            </div>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody id="tableBody" class="text-sm">

            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="flex flex-col md:flex-row justify-between items-center mt-4">
        <div class="text-sm text-gray-600 mb-2 md:mb-0" id="tableInfo">
            Showing 0 to 0 of 0 entries
        </div>
        <div class="flex space-x-1" id="paginationButtons">
            <button id="prevBtn"
                class="px-3 py-1 border rounded hover:bg-gray-100 text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
                Previous
            </button>
            <span id="pageNumbers" class="flex space-x-1"></span>
            <button id="nextBtn"
                class="px-3 py-1 border rounded hover:bg-gray-100 text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
                Next
            </button>
        </div>
    </div>
</div>



@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            let allPinpads = [];
            let currentPage = 1;
            const rowsPerPage = 10;

            loadRegional();
            loadCabangInduk();
            loadPinpads();

            function formatDate(dateStr) {
                const date = new Date(dateStr);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
            }

            function loadRegional() {
                $.ajax({
                    url: 'http://localhost:5125/api/pinpads',
                    type: 'GET',
                    dataType: 'json',
                    success: function (response) {
                        const pinpads = response.data || [];
                        let regionals = [...new Set(pinpads.map(p => p.regional).filter(r => r))];

                        const $select = $('#regionalSelect');
                        $select.empty().append('<option value="">--Select Regional--</option>');
                        regionals.forEach(reg => $select.append(`<option value="${reg}">${reg}</option>`));
                    }
                });
            }

            function loadCabangInduk(filterRegional = "") {
                $.ajax({
                    url: 'http://localhost:5125/api/pinpads',
                    type: 'GET',
                    dataType: 'json',
                    data: filterRegional ? { loc: filterRegional } : {},
                    success: function (response) {
                        const pinpads = response.data || [];
                        let cabangs = [...new Set(pinpads.map(p => `${p.cabangInduk} - ${p.location}`).filter(c => c))];

                        const $select = $('#cabangIndukSelect');
                        $select.empty().append('<option value="">--Select Cabang Induk--</option>');
                        cabangs.forEach(cb => $select.append(`<option value="${cb}">${cb}</option>`));
                    }
                });
            }

            function loadPinpads(filters = {}) {
                $.ajax({
                    url: 'http://localhost:5125/api/pinpads',
                    type: 'GET',
                    dataType: 'json',
                    data: filters,
                    success: function (response) {
                        allPinpads = response.data || [];
                        currentPage = 1; // reset halaman pertama
                        renderTable();
                    }
                });
            }

            function renderTable() {
                const start = (currentPage - 1) * rowsPerPage;
                const end = start + rowsPerPage;
                const pageData = allPinpads.slice(start, end);

                $('#tableBody').empty();
                if (pageData.length === 0) {
                    $('#tableBody').append('<tr><td colspan="15" class="text-center py-4">No data available</td></tr>');
                } else {
                    pageData.forEach(item => {
                        $('#tableBody').append(`
                            <tr class="border-b hover:bg-gray-50">
                                <td class="px-4 py-3">${item.regional ?? ''}</td>
                                <td class="px-4 py-3">${item.cabangInduk ?? ''}</td>
                                <td class="px-4 py-3">${item.kodeOutlet ?? ''}</td>
                                <td class="px-4 py-3">${item.location ?? ''}</td>
                                <td class="px-4 py-3">${item.registerDate ? formatDate(item.registerDate) : ''}</td>
                                <td class="px-4 py-3">${item.updateDate ? formatDate(item.updateDate) : ''}</td>
                                <td class="px-4 py-3">${item.serialNumber ?? ''}</td>
                                <td class="px-4 py-3">${item.tid ?? ''}</td>
                                <td class="px-4 py-3">${item.statusPinpad ?? ''}</td>
                                <td class="px-4 py-3">${item.createBy ?? ''}</td>
                                <td class="px-4 py-3">${item.ipLow ?? ''}</td>
                                <td class="px-4 py-3">${item.ipHigh ?? ''}</td>
                                <td class="px-4 py-3">${item.lastActivity ? formatDate(item.lastActivity) : ''}</td>
                            </tr>
                        `);
                    });
                }

                renderPagination();
                updatePaginationInfo();
            }

            function renderPagination() {
                const totalPages = Math.ceil(allPinpads.length / rowsPerPage);
                const $pageNumbers = $('#pageNumbers').empty();

                for (let i = 1; i <= totalPages; i++) {
                    const btn = $('<button>')
                        .text(i)
                        .addClass('px-3 py-1 border rounded text-sm transition-colors')
                        .toggleClass('bg-blue-500 text-white border-blue-500', i === currentPage)
                        .toggleClass('hover:bg-gray-100', i !== currentPage)
                        .click(() => { currentPage = i; renderTable(); });
                    $pageNumbers.append(btn);
                }

                $('#prevBtn').prop('disabled', currentPage === 1);
                $('#nextBtn').prop('disabled', currentPage === totalPages || totalPages === 0);
            }

            $('#prevBtn').click(function () {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            });

            $('#nextBtn').click(function () {
                const totalPages = Math.ceil(allPinpads.length / rowsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                }
            });

            function updatePaginationInfo() {
                const totalRows = allPinpads.length;
                const start = totalRows === 0 ? 0 : (currentPage - 1) * rowsPerPage + 1;
                const end = Math.min(currentPage * rowsPerPage, totalRows);
                $('#tableInfo').text(`Showing ${start} to ${end} of ${totalRows} entries`);
            }

            // Reload jika filter dipilih
            $('#regionalSelect').change(function () {
                const regional = $(this).val();
                loadCabangInduk(regional);
                loadPinpads({ regional });
            });

            $('#cabangIndukSelect').change(function () {
                const cabang = $(this).val();
                const regional = $('#regionalSelect').val();
                loadPinpads({ regional, cabangInduk: cabang });
            });
        });
    </script>
}
