@{
  Layout = "~/Views/Shared/_Layout.cshtml";
  ViewData["Title"] = "Users";
}

<div class="p-4 md:p-6">
  <!-- Breadcrumb -->
  <div class="mb-6 text-sm">
    <a href="#" class="text-teal-500 font-semibold hover:text-teal-600 transition-colors">Pinpad List</a> /
    <span class="text-gray-500">Monitoring</span>
  </div>

  <!-- Filter Form -->
  <div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-md mt-10">
    <h3 class="text-lg font-semibold text-gray-800 mb-6">Search & Filter</h3>

    <!-- Grid 2 Kolom -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

      <!-- Kolom Kiri -->
      <div class="space-y-4">
        <!-- Jangka Waktu -->
        <div>
          <label class="block text-gray-700 text-sm font-medium mb-2">Jangka Waktu:</label>
          <div class="flex space-x-2">
            <input type="date"
              class="w-1/2 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none">
            <input type="date"
              class="w-1/2 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none">
          </div>
        </div>

        <!-- Regional -->
        <div>
          <label class="block text-gray-700 text-sm font-medium mb-2">Regional:</label>
          <select
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none">
            <option value="">-- Select Regional --</option>
            <option>Kanwil Jakarta I</option>
            <option>Kanwil Jawa Barat</option>
          </select>
        </div>

        <!-- Cabang Induk -->
        <div>
          <label class="block text-gray-700 text-sm font-medium mb-2">Cabang Induk:</label>
          <select
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none">
            <option value="">-- Select Cabang Induk --</option>
            <option>00014 - KC JAKARTA HARMONI</option>
          </select>
        </div>

        <!-- Outlet -->
        <div>
          <label class="block text-gray-700 text-sm font-medium mb-2">Outlet:</label>
          <select
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none">
            <option value="">-- Select Outlet --</option>
          </select>
        </div>
      </div>

      <!-- Kolom Kanan -->
      <div class="space-y-4">
        <!-- Serial Number -->
        <div>
          <label class="block text-gray-700 text-sm font-medium mb-2">Serial Number:</label>
          <input type="text" placeholder="Please enter your Serial Number"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none">
        </div>

        <!-- Username -->
        <div>
          <label class="block text-gray-700 text-sm font-medium mb-2">Username:</label>
          <input type="text" placeholder="Please enter your Username"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none">
        </div>

        <!-- Response Code -->
        <div>
          <label class="block text-gray-700 text-sm font-medium mb-2">Response Code:</label>
          <select
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none">
            <option value="">-- Select Device Transaction --</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Tombol Action -->
    <div class="flex justify-end mt-6">
      <button class="bg-teal-600 text-white px-6 py-2 rounded-lg font-medium shadow hover:bg-teal-700 transition">
        Search
      </button>
    </div>
  </div>

  <!-- Export Buttons (Hidden by default) -->
  <div id="exportSection" class="hidden mb-6">
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <h4 class="text-sm font-semibold text-blue-800 mb-3">Export Data</h4>
      <div class="flex flex-wrap gap-3">
        <!-- Export PDF -->
        <button id="exportPdf"
          style="background-color: #ef4444; color: white; padding: 8px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s;"
          onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">
          PDF
        </button>

        <!-- Export XLSX -->
        <button id="exportXlsx"
          style="background-color:rgb(31, 199, 39); color: white; padding: 8px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s;"
          onmouseover="this.style.backgroundColor='#2563eb'" onmouseout="this.style.backgroundColor='#3b82f6'">
          XLSX
        </button>

        <button id="exportCsv"
          style="background-color:rgb(101, 101, 101); color: white; padding: 8px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s;"
          onmouseover="this.style.backgroundColor='#10b981'" onmouseout="this.style.backgroundColor='#10b981'">
          CSV
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay for Export -->
  <div id="exportLoading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
      <div class="flex items-center space-x-3">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
        <div>
          <p class="text-gray-800 font-medium">Exporting...</p>
          <p class="text-gray-600 text-sm">Please wait while we prepare your file</p>
        </div>
      </div>
    </div>
  </div>



  <!-- Table Container -->
  <div class="bg-white shadow-lg rounded-lg border border-gray-200 overflow-hidden">
    <!-- Table Header with Search -->
    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center mt-2 md:mt-0">
          <label class="text-sm text-gray-700 mr-3">Show:</label>
          <select id="pageSizeSelect"
            class="border border-gray-300 px-3 py-2 rounded focus:ring-2 focus:ring-blue-400 text-sm">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <span class="text-sm text-gray-700 ml-2">entries</span>
        </div>
        <!-- Search Box -->
        <div class="flex items-center gap-2">
          <label class="text-sm font-medium text-gray-700">Search:</label>
          <input type="text" id="searchInput" placeholder="Search in all columns..."
            class="border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-teal-500 focus:border-transparent min-w-[250px]">
        </div>
      </div>
    </div>



    <!-- Table Responsive Wrapper -->
    <div class="overflow-x-auto">
      <table id="pinpadLogTable" class="min-w-full text-left border-collapse">
        <thead>
          <tr class="bg-gray-100 text-gray-700 text-sm">
            <th class="px-4 py-3 font-semibold border-b border-gray-200">No</th>
            <th class="px-4 py-3 font-semibold border-b border-gray-200">Date</th>
            <th class="px-4 py-3 font-semibold border-b border-gray-200">Username</th>
            <th class="px-4 py-3 font-semibold border-b border-gray-200">Action</th>
            <th class="px-4 py-3 font-semibold border-b border-gray-200">Key Values</th>
            <th class="px-4 py-3 font-semibold border-b border-gray-200">Old Values</th>
            <th class="px-4 py-3 font-semibold border-b border-gray-200">New Values</th>
          </tr>
        </thead>
        <tbody id="tableBody" class="text-sm">
          <!-- Data API akan ditambahkan di sini -->
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="text-sm text-gray-600" id="tableInfo">
          Showing 0 to 0 of 0 entries
        </div>
        <div class="flex items-center space-x-2" id="paginationContainer">
          <button id="prevBtn"
            class="px-3 py-2 border border-gray-300 rounded hover:bg-gray-100 text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed bg-white"
            disabled>
            Previous
          </button>
          <div id="pageNumbers" class="flex space-x-1"></div>
          <button id="nextBtn"
            class="px-3 py-2 border border-gray-300 rounded hover:bg-gray-100 text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed bg-white"
            disabled>
            Next
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    let allLogs = [];
    let currentPage = 1;
    let pageSize = 10;
    let searchTerm = "";

    async function loadPinpadLogs() {
      try {
        const res = await fetch("http://localhost:5125/api/audit/pinpads");
        if (!res.ok) {
          console.error("Gagal fetch log Pinpad:", res.statusText);
          return;
        }

        allLogs = await res.json();
        renderTable();
      } catch (err) {
        console.error("Error load logs:", err);
      }
    }

    function renderTable() {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";

      // Filter data sesuai search
      const filteredLogs = allLogs.filter(log => {
        const values = Object.values(log).join(" ").toLowerCase();
        return values.includes(searchTerm.toLowerCase());
      });

      const totalEntries = filteredLogs.length;

      if (totalEntries === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4">Data tidak ditemukan</td></tr>`;
        document.getElementById("tableInfo").innerText = "Showing 0 to 0 of 0 entries";
        renderPagination(0, 0, 0);
        return;
      }

      // Pagination
      const start = (currentPage - 1) * pageSize;
      const end = Math.min(start + pageSize, totalEntries);
      const pagedLogs = filteredLogs.slice(start, end);

      pagedLogs.forEach((log, index) => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50";

        // Badge warna sesuai action
        let badge = `<span class="px-2 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-700">${log.actionType}</span>`;
        if (log.actionType === "Created") {
          badge = `<span class="px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">Created</span>`;
        } else if (log.actionType === "Updated") {
          badge = `<span class="px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-700">Updated</span>`;
        } else if (log.actionType === "Deleted") {
          badge = `<span class="px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">Deleted</span>`;
        }

        tr.innerHTML = `
            <td class="px-4 py-3 border-b border-gray-200 text-center">${start + index + 1}</td>
            <td class="px-4 py-3 border-b border-gray-200">${new Date(log.dateTimes).toLocaleString()}</td>
            <td class="px-4 py-3 border-b border-gray-200">${log.username || "-"}</td>
            <td class="px-4 py-3 border-b border-gray-200">${badge}</td>
            <td class="px-4 py-3 border-b border-gray-200 break-words">${log.keyValues || ""}</td>
            <td class="px-4 py-3 border-b border-gray-200 align-top">
                <pre class="whitespace-pre-wrap break-all text-xs max-w-md overflow-x-auto">${log.oldValues || ""}</pre>
            </td>
            <td class="px-4 py-3 border-b border-gray-200 align-top">
                <pre class="whitespace-pre-wrap break-all text-xs max-w-md overflow-x-auto">${log.newValues || ""}</pre>
            </td>
          `;

        tbody.appendChild(tr);
      });

      // Update table info
      document.getElementById("tableInfo").innerText =
        `Showing ${start + 1} to ${end} of ${totalEntries} entries`;

      // Render pagination
      renderPagination(totalEntries, start, end);
    }

    function renderPagination(totalEntries, start, end) {
      const totalPages = Math.ceil(totalEntries / pageSize);
      const pageNumbersContainer = document.getElementById("pageNumbers");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");

      pageNumbersContainer.innerHTML = "";

      // Buat nomor halaman
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.innerText = i;
        btn.className = `px-3 py-1 border rounded text-sm transition-colors ${i === currentPage
            ? "bg-teal-500 text-white border-teal-500"
            : "bg-white border-gray-300 hover:bg-gray-100"
          }`;
        btn.addEventListener("click", () => {
          currentPage = i;
          renderTable();
        });
        pageNumbersContainer.appendChild(btn);
      }

      // Previous & Next button
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;

      prevBtn.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          renderTable();
        }
      };

      nextBtn.onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderTable();
        }
      };
    }

    // Event listener untuk dropdown Show entries
    $(document).on("change", "#pageSizeSelect", function () {
      pageSize = parseInt($(this).val());
      currentPage = 1; // reset ke halaman pertama
      renderTable();
    });

    // Event listener untuk search real-time
    $(document).on("input", "#searchInput", function () {
      searchTerm = $(this).val();
      currentPage = 1; // reset ke halaman pertama
      renderTable();
    });

    // Auto load saat halaman ready
    $(document).ready(loadPinpadLogs);
  </script>
}
