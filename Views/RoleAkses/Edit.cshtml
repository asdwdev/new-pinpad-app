@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Edit System Level";
    var levelId = ViewBag.LevelId; // nanti kirim dari controller MVC
}

<div class="max-w-5xl mx-auto bg-white shadow-md rounded-xl p-6">
    <h2 class="text-xl font-semibold mb-6">Edit Access Role</h2>

    <form id="editSysLevelForm">
        <input type="hidden" id="levelId" value="@levelId" />

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- LEFT: Menu List -->
            <div class="md:col-span-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">Assign Menus</label>
                <div id="menuList" class="border p-3 rounded-md max-h-[500px] overflow-y-auto space-y-2 bg-gray-50">
                    <!-- Checkbox menu generated by JS -->
                </div>
            </div>

            <!-- RIGHT: SysLevel Form -->
            <div class="md:col-span-2 space-y-4">
                <!-- Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="name" name="name" required
                        class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none">
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="description" name="description" rows="5"
                        class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none"></textarea>
                </div>

                <!-- Save & Cancel -->
                <div class="flex justify-end space-x-3 pt-4">
                    <a href="/RoleAkses/Index"
                        class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100">
                        Cancel
                    </a>
                    <button type="submit" class="px-4 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-700">
                        Update
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    $(document).ready(function () {
        const levelId = $("#levelId").val();

        // Recursive render menu (parent + children)
        function renderMenu(menu, assignedIds) {
            let checked = assignedIds.includes(menu.id) ? "checked" : "";
            let localHtml = `
                <div class="border rounded-md p-2 bg-white">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="menus" value="${menu.id}" class="h-4 w-4" ${checked}>
                        <span class="font-medium">${menu.name}</span>
                    </label>`;

            if (menu.children && menu.children.length > 0) {
                localHtml += `<div class="ml-6 mt-2 space-y-1">`;
                menu.children.forEach(child => {
                    localHtml += renderMenu(child, assignedIds);
                });
                localHtml += `</div>`;
            }

            localHtml += `</div>`;
            return localHtml;
        }

        // Load detail level + assigned menus
        $.when(
            $.get(`http://localhost:5125/api/syslevels/${levelId}`),
            $.get("http://localhost:5125/api/sysmenus")
        ).done(function (levelRes, menuRes) {
            const level = levelRes[0];
            const assignedMenus = level.menuIds || [];   // <-- ambil dari SysLevelController
            const menus = menuRes[0];

            $("#name").val(level.name);
            $("#description").val(level.description);

            let html = "";
            menus.forEach(menu => {
                html += renderMenu(menu, assignedMenus);
            });
            $("#menuList").html(html);
        });

        // Sync parent-child checkbox
        $(document).on("change", "input[name='menus']", function () {
            const isChecked = $(this).is(":checked");

            // cascade ke child
            $(this).closest("div").find("input[name='menus']").prop("checked", isChecked);

            // kalau uncheck child, auto uncheck parent
            if (!isChecked) {
                $(this).parents("div").each(function () {
                    $(this).children("label").find("input[name='menus']").prop("checked", false);
                });
            }
        });

        // Handle update system level
        $("#editSysLevelForm").on("submit", function (e) {
            e.preventDefault();

            const selectedMenus = $("input[name='menus']:checked").map(function () {
                return parseInt($(this).val());
            }).get();

            const formData = {
                name: $("#name").val(),
                description: $("#description").val(),
                menuIds: selectedMenus
            };

            $.ajax({
                url: `http://localhost:5125/api/syslevels/${levelId}`,
                method: "PUT",
                contentType: "application/json",
                data: JSON.stringify(formData),
                success: function () {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: 'System Level has been updated successfully!',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = "/RoleAkses/Index";
                    });
                },
                error: function (xhr) {
                    const res = xhr.responseJSON;
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed',
                        text: res?.message || 'Failed to update system level'
                    });
                }
            });
        });
    });
</script>
