@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Create System Level";
}

<div class="max-w-5xl mx-auto bg-white shadow-md rounded-xl p-6">
    <h2 class="text-xl font-semibold mb-6">Create System Level</h2>

    <form id="createSysLevelForm">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- LEFT: Menu List -->
            <div class="md:col-span-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">Assign Menus</label>
                <div id="menuList" class="border p-3 rounded-md max-h-[500px] overflow-y-auto space-y-2 bg-gray-50">
                    <!-- Checkbox menu generated by JS -->
                </div>
            </div>

            <!-- RIGHT: SysLevel Form -->
            <div class="md:col-span-2 space-y-4">
                <!-- Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" name="name" required
                        class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none"
                        placeholder="Enter system level name">
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea name="description" rows="5"
                        class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none"
                        placeholder="Enter description"></textarea>
                </div>

                <!-- Save & Cancel -->
                <div class="flex justify-end space-x-3 pt-4">
                    <a href="/SysLevel/Index"
                        class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100">
                        Cancel
                    </a>
                    <button type="submit" class="px-4 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-700">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    $(document).ready(function () {

        // Recursive render menu (parent + children)
        function renderMenu(menu) {
            let html = `
                <div class="border rounded-md p-2 bg-white">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="menus" value="${menu.id}" class="h-4 w-4">
                        <span class="font-medium">${menu.name}</span>
                    </label>`;

            if (menu.children && menu.children.length > 0) {
                html += `<div class="ml-6 mt-2 space-y-1">`;
                menu.children.forEach(child => {
                    html += renderMenu(child);
                });
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        // Load menus from API
        $.ajax({
            url: "http://localhost:5125/api/sysmenus",
            method: "GET",
            success: function (res) {
                if (Array.isArray(res)) {
                    let html = "";
                    res.forEach(menu => {
                        html += renderMenu(menu);
                    });
                    $("#menuList").html(html);
                }
            }
        });

        // Sync parent-child checkbox
        $(document).on("change", "input[name='menus']", function () {
            const isChecked = $(this).is(":checked");

            // cascade ke child
            $(this).closest("div").find("input[name='menus']").prop("checked", isChecked);

            // kalau uncheck child, auto uncheck parent
            if (!isChecked) {
                $(this).parents("div").each(function () {
                    $(this).children("label").find("input[name='menus']").prop("checked", false);
                });
            }
        });

        // Handle create system level
        $("#createSysLevelForm").on("submit", function (e) {
            e.preventDefault();

            const selectedMenus = $("input[name='menus']:checked").map(function () {
                return parseInt($(this).val());
            }).get();

            const formData = {
                name: $("input[name='name']").val(),
                description: $("textarea[name='description']").val(),
                menuIds: selectedMenus
            };

            $.ajax({
                url: "http://localhost:5125/api/syslevels",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(formData),
                success: function (res) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: res.message || 'System Level has been created successfully!',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = "/RoleAkses/Index";
                    });
                },
                error: function (xhr) {
                    const res = xhr.responseJSON;
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed',
                        text: res?.message || 'Failed to create system level'
                    });
                }
            });
        });
    });
</script>
