<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DashboardApp</title>

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .no-transitions * {
            transition: none !important;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans">
    <!-- Sidebar Layout -->
    <div class="flex min-h-screen transition-transform duration-300 ease-in-out">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed md:sticky md:top-0 inset-y-0 left-0 z-40 w-64 md:w-72
           bg-gradient-to-br from-purple-700 via-purple-800 to-red-700 text-white
           transform -translate-x-full md:translate-x-0
           transition-transform duration-300 ease-in-out
           h-screen overflow-y-auto shadow-2xl">

            <!-- Sidebar Header -->
            <div id="sidebarHeader"
                class="p-6 border-b border-white border-opacity-20 flex items-center justify-between cursor-pointer">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center backdrop-blur-sm">
                        <img src="~/img/Logo-BTN.png" alt="Logo" class="w-8 h-8 object-contain">
                    </div>
                    <div>
                        <h1 class="text-lg md:text-xl font-bold leading-tight">NEW PINPAD</h1>
                        <p class="text-xs md:text-sm text-purple-200">Admin Dashboard</p>
                    </div>
                </div>
            </div>

            <!-- Navigation Menu -->
            <nav id="dynamicMenu" class="p-4 space-y-2">
                <!-- menu dari database akan diinject JS -->
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-w-0 transition-transform duration-300 ease-in-out">
            <!-- Top Bar -->
            <header class="bg-white shadow-sm border-b border-gray-200 px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <!-- Left Section: Burger + Title -->
                    <div class="flex items-center gap-3">
                        <!-- Mobile Menu Button -->
                        <button id="mobileMenuBtn"
                            class="md:hidden bg-gradient-to-r from-purple-600 to-purple-700 text-white p-3 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105">
                            <i class="fa fa-bars text-lg"></i>
                        </button>
                        <!-- Page Title -->
                        <div>
                            <h2 class="text-lg sm:text-xl md:text-2xl font-semibold text-gray-800">Dashboard</h2>
                            <p class="text-xs sm:text-sm text-gray-500 mt-1">Welcome back to your admin panel</p>
                        </div>
                    </div>

                    <!-- Right Section: User Menu -->
                    <div class="relative">
                        <button id="userMenuButton" type="button"
                            class="flex items-center space-x-3 text-sm bg-white border border-gray-200 rounded-xl px-4 py-2 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all duration-200">
                            <div
                                class="w-8 h-8 bg-gradient-to-r from-purple-600 to-purple-700 rounded-lg flex items-center justify-center">
                                <i class="fa fa-user text-white text-sm"></i>
                            </div>
                            <span id="currentUser" class="hidden sm:block font-medium text-gray-700">Admin</span>
                            <i class="fa-solid fa-chevron-down text-gray-400 text-xs"></i>
                        </button>

                        <!-- User Dropdown -->
                        <div id="userMenuDropdown"
                            class="hidden absolute right-0 mt-2 min-w-[12rem] bg-white rounded-xl shadow-lg border border-gray-100 z-50 overflow-hidden">
                            <div class="py-2">
                                <a href="#" id="logoutBtn"
                                    class="flex items-center gap-3 px-4 py-3 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                    <i class="fa-solid fa-sign-out-alt text-red-500"></i>
                                    <span>Logout</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="flex-1 p-4 sm:p-6 lg:p-8 overflow-auto">
                <div class="max-w-5xl mx-auto">
                    @RenderBody()
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Overlay -->
    <div id="overlay"
        class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden transition-opacity duration-300"></div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script>
        $(function () {
            const sidebar = $("#sidebar");
            const userMenuBtn = $("#userMenuButton");
            const userMenuDropdown = $("#userMenuDropdown");

            // ---- Ambil user login ----
            $.ajax({
                url: "http://localhost:5125/api/auth/me",
                method: "GET",
                xhrFields: { withCredentials: true },
                crossDomain: true,
                success: function (res) {
                    if (!res || !res.success) {
                        window.location.href = "/Auth/Login";
                        return;
                    }
                    // Ganti text di topbar (pakai FullName kalau ada, fallback ke Username)
                    $("#currentUser").text(res.fullName || res.username);

                    const levelId = res.accessLevel;

                    // ---- Ambil menu sesuai level ----
                    $.ajax({
                        url: `http://localhost:5125/api/levelmenus/${levelId}`,
                        method: "GET",
                        success: function (menus) {
                            // build tree
                            const menuMap = {};
                            menus.forEach(m => {
                                m.children = [];
                                menuMap[m.id] = m;
                            });

                            const roots = [];
                            menus.forEach(m => {
                                if (m.parentId) {
                                    menuMap[m.parentId]?.children.push(m);
                                } else {
                                    roots.push(m);
                                }
                            });

                            // render recursive
                            function renderMenu(items) {
                                let html = "";
                                items.forEach(menu => {
                                    if (menu.children.length > 0) {
                                        html += `
                                        <div class="mb-2">
                                            <div class="flex items-center p-3 rounded-xl hover:bg-white hover:bg-opacity-10 transition-all group justify-between cursor-pointer" 
                                                 data-toggle="submenu" data-id="${menu.id}">
                                                <div class="flex items-center">
                                                    <i class="${menu.icon} w-5"></i>
                                                    <span class="ml-3">${menu.name}</span>
                                                </div>
                                                <i class="fa fa-chevron-down text-xs transition-transform duration-200"></i>
                                            </div>
                                            <div id="submenu-${menu.id}" class="ml-6 mt-1 hidden space-y-1">
                                                ${renderMenu(menu.children)}
                                            </div>
                                        </div>`;
                                    } else {
                                        html += `
                                        <a href="${menu.urls || '#'}"
                                           class="menu-link flex items-center p-3 rounded-xl hover:bg-white hover:bg-opacity-10 transition-all ml-2"
                                           data-url="${menu.urls}">
                                            <i class="${menu.icon} w-5"></i>
                                            <span class="ml-3">${menu.name}</span>
                                        </a>`;
                                    }
                                });
                                return html;
                            }

                            $("#dynamicMenu").html(renderMenu(roots));

                            // --- Highlight menu aktif berdasarkan path ---
                            setTimeout(() => {
                                const currentPath = window.location.pathname.toLowerCase();

                                const $activeLink = $(`#dynamicMenu .menu-link`).filter(function () {
                                    const url = $(this).data("url");
                                    return url && currentPath.startsWith(url.toLowerCase());
                                }).first();

                                if ($activeLink.length) {
                                    $activeLink.addClass("bg-white bg-opacity-20 font-semibold text-white");

                                    // kalau dia submenu, buka parent-nya
                                    const submenu = $activeLink.closest("[id^='submenu-']");
                                    if (submenu.length) {
                                        submenu.show();
                                        submenu.prev("[data-toggle='submenu']")
                                            .find(".fa-chevron-down")
                                            .addClass("rotate-180");
                                    }
                                }
                            }, 300);
                        },
                        error: function () {
                            $("#dynamicMenu").html(`<p class="text-red-400">Failed to load menus</p>`);
                        }
                    });
                },
                error: function () {
                    window.location.href = "/Auth/Login";
                }
            });

            // --- Submenu toggle ---
            $(document).on("click", "[data-toggle='submenu']", function () {
                const id = $(this).data("id");
                $(`#submenu-${id}`).slideToggle(200);
                $(this).find(".fa-chevron-down").toggleClass("rotate-180");
            });

            // --- Logout ---
            $("#logoutBtn").on("click", function (e) {
                e.preventDefault();
                $.ajax({
                    url: "http://localhost:5125/api/auth/logout",
                    method: "POST",
                    xhrFields: { withCredentials: true },
                    crossDomain: true,
                    success: function (res) {
                        if (res && res.success) {
                            window.location.href = "/Auth/Login";
                        }
                    }
                });
            });

            // --- User dropdown toggle ---
            userMenuBtn.on("click", function (e) {
                e.stopPropagation();
                userMenuDropdown.toggleClass("hidden");
            });

            $(document).on("click", function (e) {
                if (!userMenuBtn[0].contains(e.target) && !userMenuDropdown[0].contains(e.target)) {
                    userMenuDropdown.addClass("hidden");
                }
            });

            // --- Klik menu link -> highlight langsung ---
            $(document).on("click", ".menu-link", function () {
                $("#dynamicMenu .menu-link").removeClass("bg-white bg-opacity-20 font-semibold text-white");
                $(this).addClass("bg-white bg-opacity-20 font-semibold text-white");
            });

            // --- Mobile menu toggle ---
            $("#mobileMenuBtn").on("click", function () {
                $("#sidebar").toggleClass("-translate-x-full translate-x-0");
                $("#mainContent").toggleClass("translate-x-64 md:translate-x-72");
                $("#overlay").removeClass("hidden");    // tampilkan overlay
                $("#mobileMenuBtn").addClass("hidden"); // sembunyikan tombol burger
            });

            // --- Klik overlay untuk menutup ---
            $("#overlay").on("click", closeSidebar);

            // --- Klik sidebar header juga untuk menutup ---
            $("#sidebarHeader").on("click", closeSidebar);

            // --- Fungsi reusable untuk nutup sidebar ---
            function closeSidebar() {
                $("#sidebar").addClass("-translate-x-full").removeClass("translate-x-0");
                $("#mainContent").removeClass("translate-x-64 md:translate-x-72");
                $("#overlay").addClass("hidden");
                $("#mobileMenuBtn").removeClass("hidden");
            }
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>

</html>