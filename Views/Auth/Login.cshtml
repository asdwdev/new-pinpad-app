@{
    Layout = "~/Views/Shared/_AuthLayout.cshtml";
    ViewData["Title"] = "Login";
}

<div class="text-center mb-6">
    <h2 class="text-2xl font-bold text-gray-800">Login</h2>
    <p class="text-gray-500">Silakan masuk untuk melanjutkan</p>
</div>

<div id="message" class="hidden mb-4 rounded-lg border px-4 py-3 text-sm font-medium" role="alert">
</div>

<form id="loginForm" class="space-y-4">
    <!-- Username -->
    <div>
        <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
        <input type="text" id="username" name="username" required
            class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-700 shadow-sm focus:border-purple-500 focus:ring focus:ring-purple-300 focus:ring-opacity-50" />
    </div>

    <!-- Password -->
    <div>
        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
        <input type="password" id="password" name="password" required
            class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-700 shadow-sm focus:border-purple-500 focus:ring focus:ring-purple-300 focus:ring-opacity-50" />
    </div>

    <!-- Tombol Login -->
    <div>
        <button type="submit"
            class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 shadow-md">
            Login
        </button>
    </div>
</form>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // --- Handle form submit ---
        $("#loginForm").submit(function (e) {
            e.preventDefault();

            $.ajax({
                url: "http://localhost:5125/api/auth/login",
                method: "POST",
                contentType: "application/json",
                xhrFields: { withCredentials: true },
                data: JSON.stringify({
                    username: $("#username").val(),
                    password: $("#password").val()
                }),
                success: function (res) {
                    if (res.success) {
                        // redirect sesuai role
                        const accessLevel = parseInt(res.user.accessLevel || "0", 10);

                        if (accessLevel === 1 || accessLevel === 3 || accessLevel === 4) {
                            window.location.href = "/Dashboard/Index";
                        } else if (accessLevel === 2) {
                            window.location.href = "/Branch/Index";
                        } else {
                            showMessage("Invalid username or password", false);
                        }
                    } else {
                        showMessage(res.message || "Invalid username or password", false);
                    }
                },
                error: function (xhr, status, error) {
                    let msg = "An error occurred while trying to login."; // default
                    if (xhr.status === 0) {
                        // server API-nya gak bisa diakses (mungkin dotnet belum jalan)
                        msg = "Unable to connect to the server. Please make sure the backend is running.";
                    } else {
                        try {
                            const err = JSON.parse(xhr.responseText);
                            msg = err.message || msg;
                        } catch { }
                    }
                    showMessage(msg, false);
                }
            });
        });

        // --- Helper show message ---
        function showMessage(message, isSuccess) {
            $("#message")
                .removeClass("hidden border-green-300 bg-green-50 text-green-800 border-red-300 bg-red-50 text-red-800")
                .addClass(isSuccess
                    ? "border-green-300 bg-green-50 text-green-800"
                    : "border-red-300 bg-red-50 text-red-800")
                .text(message);
        }
    </script>
}
