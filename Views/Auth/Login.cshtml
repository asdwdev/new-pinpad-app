@{
    Layout = "~/Views/Shared/_AuthLayout.cshtml";
    ViewData["Title"] = "Login";
}

<div class="text-center mb-6">
    <h2 class="text-2xl font-bold text-gray-800">Login</h2>
    <p class="text-gray-500">Silakan masuk untuk melanjutkan</p>
</div>

<div id="message" class="hidden mb-4 rounded-lg border px-4 py-3 text-sm font-medium" role="alert">
</div>

<form id="loginForm" class="space-y-4">
    <!-- Username -->
    <div>
        <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
        <input type="text" id="username" name="username" required
            class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-700 shadow-sm focus:border-purple-500 focus:ring focus:ring-purple-300 focus:ring-opacity-50" />
    </div>

    <!-- Password -->
    <div>
        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
        <input type="password" id="password" name="password" required
            class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-700 shadow-sm focus:border-purple-500 focus:ring focus:ring-purple-300 focus:ring-opacity-50" />
    </div>

    <!-- Tombol Login -->
    <div>
        <button id="btnLogin" type="submit"
            class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 shadow-md flex items-center justify-center">
            <span id="btnText">Login</span>
            <svg id="btnSpinner" class="hidden ml-2 w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg"
                fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
        </button>
    </div>

</form>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $("#loginForm").submit(function (e) {
            e.preventDefault();

            // --- set loading state ---
            $("#btnLogin").prop("disabled", true);
            $("#btnText").text("Loading...");
            $("#btnSpinner").removeClass("hidden");

            $.ajax({
                url: "http://localhost:5125/api/auth/login",
                method: "POST",
                contentType: "application/json",
                xhrFields: { withCredentials: true },
                data: JSON.stringify({
                    username: $("#username").val(),
                    password: $("#password").val()
                }),
                success: function (res) {
                    if (res.success && res.user) {
                        window.location.href = "/Dashboard/Index";
                    } else {
                        showMessage(res.message || "Invalid username or password", false);
                    }
                },
                error: function (xhr) {
                    let msg = "An error occurred while trying to login.";
                    if (xhr.status === 0) {
                        msg = "Unable to connect to the server. Please make sure the backend is running.";
                    } else {
                        try {
                            const err = JSON.parse(xhr.responseText);
                            msg = err.message || msg;
                        } catch { }
                    }
                    showMessage(msg, false);
                },
                complete: function () {
                    // --- reset loading state ---
                    $("#btnLogin").prop("disabled", false);
                    $("#btnText").text("Login");
                    $("#btnSpinner").addClass("hidden");
                }
            });
        });


        // --- Helper show message ---
        function showMessage(message, isSuccess) {
            $("#message")
                .removeClass("hidden border-green-300 bg-green-50 text-green-800 border-red-300 bg-red-50 text-red-800")
                .addClass(isSuccess
                    ? "border-green-300 bg-green-50 text-green-800"
                    : "border-red-300 bg-red-50 text-red-800")
                .text(message);
        }
    </script>
}
