@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Create User";
}

<div class="max-w-3xl mx-auto bg-white shadow-md rounded-xl p-6">
    <h2 class="text-xl font-semibold mb-6">Create User</h2>

    <form id="createUserForm" class="space-y-4">
        <!-- Username -->
        <div>
            <label class="block text-sm font-medium text-gray-700">Username</label>
            <input type="text" name="username" required
                class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                placeholder="Enter username">
        </div>

        <!-- Password -->
        <div>
            <label class="block text-sm font-medium text-gray-700">Password</label>
            <input type="password" name="password" required
                class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                placeholder="Enter password">
        </div>

        <!-- Full Name -->
        <div>
            <label class="block text-sm font-medium text-gray-700">Full Name</label>
            <input type="text" name="fullName" required
                class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                placeholder="Enter full name">
        </div>

        <!-- Email -->
        <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" name="email" required
                class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                placeholder="Enter email">
        </div>

        <!-- Type -->
        <div>
            <label class="block text-sm font-medium text-gray-700">Type</label>
            <select name="type" required
                class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <option value="">-- Select Type --</option>
                <option value="1">Internal</option>
                <option value="2">External</option>
            </select>
        </div>

        <!-- Access Level -->
        <div>
            <label class="block text-sm font-medium text-gray-700">Access Level</label>
            <select id="accessLevelSelect" name="accessLevel" required
                class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <option value="">-- Select Access Level --</option>
            </select>
        </div>


        <!-- Branch -->
        <div>
            <label class="block text-sm font-medium text-gray-700">Branch Type</label>
            <select name="branch" id="branchSelect"
                class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <option value="">-- Select Branch Type --</option>
            </select>
        </div>

        <!-- NIP -->
        <div>
            <label class="block text-sm font-medium text-gray-700">NIP</label>
            <input type="text" name="nip"
                class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                placeholder="Enter NIP">
        </div>

        <!-- Locked -->
        <div class="flex items-center space-x-2">
            <input type="checkbox" name="isLocked" id="isLocked" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
            <label for="isLocked" class="text-sm font-medium text-gray-700">Locked</label>
        </div>

        <!-- Save & Cancel -->
        <div class="flex justify-end space-x-3 pt-4">
            <button type="button" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100">
                Cancel
            </button>
            <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
                Save
            </button>
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    $(document).ready(function () {
        // Load branch types
        loadBranchTypes();

        // Load sys levels for dropdown
        loadSysLevels();

        function loadBranchTypes() {
            $.ajax({
                url: "http://localhost:5125/api/branches/branch-types",
                method: "GET",
                success: function (res) {
                    if (Array.isArray(res)) {
                        res.forEach(branch => {
                            $("#branchSelect").append(
                                `<option value="${branch.code}">${branch.name} (${branch.code})</option>`
                            );
                        });
                    }
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to load branch types'
                    });
                }
            });
        }

        function loadSysLevels() {
            $.ajax({
                url: "http://localhost:5125/api/syslevels/dropdown",
                method: "GET",
                success: function (res) {
                    if (Array.isArray(res)) {
                        res.forEach(level => {
                            $("#accessLevelSelect").append(
                                `<option value="${level.id}">${level.name}</option>`
                            );
                        });
                    }
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to load access levels'
                    });
                }
            });
        }

        // Handle create user
        $("#createUserForm").on("submit", function (e) {
            e.preventDefault();

            const formData = {
                username: $("input[name='username']").val(),
                password: $("input[name='password']").val(),
                fullName: $("input[name='fullName']").val(),
                email: $("input[name='email']").val(),
                type: $("select[name='type']").val(),
                accessLevel: $("#accessLevelSelect").val(), // ambil dari API dropdown
                branch: $("#branchSelect").val(),
                nip: $("input[name='nip']").val(),
                isLocked: $("#isLocked").is(":checked")
            };

            $.ajax({
                url: "http://localhost:5125/api/users",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(formData),
                success: function (res) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: res.message || 'User has been created successfully!',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = "/User/Index";
                    });
                },
                error: function (xhr) {
                    const res = xhr.responseJSON;
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed',
                        text: res?.message || 'Failed to create user'
                    });
                }
            });
        });
    });
</script>
